<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Generator & Scanner</title>

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- QRious –≥–µ–Ω–µ—Ä–∞—Ü–∏—è -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"
          integrity="sha512-pUhApVQtLbnpLtJn6DuzDD5o2xtmLJnJ7oBoMsBnzOkVkpqofGLGPaBJ6ayD2zQe3lCgCibhJBi4cj5wAxwVKA=="
          crossorigin="anonymous"></script>
  <!-- html5-qrcode —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    /* --- –ú–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –Ω–æ —è—Å–Ω—ã–π —Å—Ç–∏–ª—å --- */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
         background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);
         padding:20px;min-height:100vh;overflow-x:hidden}
    .container{max-width:720px;margin:0 auto}
    h3{text-align:center;margin-bottom:8px;font-weight:600}
    .description{text-align:center;margin:0 10px 18px;color:var(--tg-theme-hint-color,#999);font-size:14px}
    .tabs{display:flex;gap:10px;margin-bottom:18px;background:var(--tg-theme-secondary-bg-color,#f4f4f4);
          padding:6px;border-radius:12px}
    .tab{flex:1;padding:12px;text-align:center;border-radius:8px;cursor:pointer;font-weight:500;user-select:none}
    .tab.active{background:var(--tg-theme-button-color,#007aff);color:var(--tg-theme-button-text-color,#fff)}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn .22s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:10px;border:1px solid #ccc;
             background:var(--tg-theme-secondary-bg-color,#f4f4f4);resize:vertical;font-size:15px}
    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;padding:12px;border-radius:8px;border:0;font-size:15px;cursor:pointer}
    .btn-primary{background:var(--tg-theme-button-color,#007aff);color:var(--tg-theme-button-text-color,#fff)}
    .btn-secondary{background:var(--tg-theme-secondary-bg-color,#f4f4f4)}
    .btn-danger{background:#ff3b30;color:#fff}
    #qrcode-container{display:none;margin-top:18px;align-items:center;gap:12px}
    #qrcode{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    #qrcode canvas{display:block;max-width:100%;height:auto}
    .stats{margin-top:12px;font-size:13px;color:var(--tg-theme-hint-color,#999);text-align:center}
    #qr-reader{width:100%;max-width:360px;margin:0 auto}
    .scanner-controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .camera-switch{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.45);color:#fff;border:0;border-radius:50%;
                   width:40px;height:40px;font-size:18px;cursor:pointer;z-index:10}
    .spinner{border:3px solid #f3f3f3;border-top:3px solid var(--tg-theme-button-color,#007aff);border-radius:50%;
             width:24px;height:24px;animation:spin 1s linear infinite;margin:0 auto 8px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .scan-result{background:var(--tg-theme-secondary-bg-color,#f4f4f4);padding:12px;border-radius:10px;margin-top:12px}
    .scan-result-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .scan-result-text{word-break:break-all;white-space:pre-wrap}
    .web-notification{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#4caf50;color:#fff;padding:10px 18px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.12);z-index:1000}
    /* Responsive small */
    @media (max-width:480px){.tabs{gap:6px}.camera-switch{top:6px;right:6px}}
  </style>
</head>
<body>
  <div class="container">
    <h3></h3>
    <p class="description"></p>

    <div class="tabs" role="tablist" aria-label="Generator and Scanner tabs">
      <div class="tab active" data-tab="generator" role="tab">‚úèÔ∏è –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</div>
      <div class="tab" data-tab="scanner" role="tab">üì∑ –°–∫–∞–Ω–µ—Ä</div>
    </div>

    <!-- Generator -->
    <div id="generator" class="tab-content active" role="tabpanel">
      <textarea id="text-input" autocomplete="off" spellcheck="false"></textarea>
      <div class="controls">
        <button id="generate-btn" class="btn btn-primary"></button>
        <button id="download-btn" class="btn btn-secondary"></button>
      </div>
      <div id="qrcode-container">
        <div id="qrcode" aria-hidden="false"></div>
        <div class="stats" id="stats"></div>
      </div>
    </div>

    <!-- Scanner -->
    <div id="scanner" class="tab-content" role="tabpanel" aria-hidden="true">
      <div class="scanner-controls">
        <button id="start-scan-btn" class="btn btn-primary"></button>
        <button id="upload-scan-btn" class="btn btn-secondary"></button>
      </div>
      <input type="file" id="qr-input-file" accept="image/*" style="display:none" />
      <div id="scanner-container" style="display:none; margin-top:16px; position:relative;">
        <button id="camera-switch-btn" class="camera-switch" aria-label="Switch camera" title="Switch camera">üîÑ</button>
        <div id="qr-reader"></div>
      </div>
      <div id="scanner-status" style="display:none; text-align:center; margin-top:12px;">
        <div class="spinner" role="status" aria-hidden="true"></div>
        <div id="status-text"></div>
      </div>
      <div id="scan-result-container" style="display:none;">
        <div class="scan-result">
          <div class="scan-result-header">
            <strong id="scan-result-title"></strong>
            <button id="copy-result-btn" class="btn btn-secondary" style="padding:6px 12px; font-size:14px"></button>
          </div>
          <div id="scan-result-text" class="scan-result-text"></div>
        </div>
        <div class="scanner-controls" style="margin-top:12px">
          <button id="use-result-btn" class="btn btn-primary"></button>
          <button id="scan-again-btn" class="btn btn-secondary"></button>
        </div>
      </div>
      <div style="margin-top:12px">
        <button id="stop-scan-btn" class="btn btn-danger" style="display:none"></button>
      </div>
    </div>
  </div>

<script>
/* ===========================
   i18n / —Ç–µ–∫—Å—Ç—ã
   =========================== */
const translations = {
  ru: {
    generate: '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥',
    placeholder: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, —Å—Å—ã–ª–∫—É –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è QR-–∫–æ–¥–∞...',
    download: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å QR-–∫–æ–¥',
    saved: 'QR-–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω',
    errorEmpty: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å—Å—ã–ª–∫—É!',
    errorTooLong: '–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ú–∞–∫—Å–∏–º—É–º 2953 —Å–∏–º–≤–æ–ª–∞.',
    scanningStatus: '–ü–æ–∏—Å–∫ QR-–∫–æ–¥–∞...',
    scanCamera: 'üì∑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É',
    scanFile: 'üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ',
    copy: 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
    useResult: '‚úèÔ∏è –°–æ–∑–¥–∞—Ç—å QR',
    scanAgain: 'üîÑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë',
    stopScan: '‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',
    scannedResult: '‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:',
    chars: '—Å–∏–º–≤–æ–ª–æ–≤ ‚Ä¢',
    url: 'URL',
    text: '–¢–µ–∫—Å—Ç',
    analysis: '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...',
    notFound: 'QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏',
    copied: '–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω',
    errorGen: '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞',
    cameraDenied: '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.',
    cameraNotFound: '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.',
    saveFailed: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏',
    openLink: '–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É',
    call: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å',
    email: '–ù–∞–ø–∏—Å–∞—Ç—å E-mail'
  },
  en: {
    generate: 'Generate QR code',
    placeholder: 'Enter text, URL or data for QR code...',
    download: 'üíæ Save QR code',
    saved: 'QR code saved',
    errorEmpty: 'Please enter text or URL!',
    errorTooLong: 'Text too long. Maximum 2953 characters.',
    scanningStatus: 'Scanning for QR code...',
    scanCamera: 'üì∑ Start camera',
    scanFile: 'üñºÔ∏è Upload photo',
    copy: 'üìã Copy',
    useResult: '‚úèÔ∏è Generate QR',
    scanAgain: 'üîÑ Scan again',
    stopScan: '‚õî Stop scanning',
    scannedResult: '‚úÖ Scan result:',
    chars: 'characters ‚Ä¢',
    url: 'URL',
    text: 'Text',
    analysis: 'Analysing image...',
    notFound: 'QR code not found on image',
    copied: 'Text copied',
    errorGen: 'QR code generation error',
    cameraDenied: 'Camera access denied. Allow in browser settings.',
    cameraNotFound: 'Camera not found on device.',
    saveFailed: 'Save failed',
    openLink: 'Open Link',
    call: 'Call',
    email: 'Send E-mail'
  }
};

let lang = 'en';
if (window.Telegram?.WebApp?.initDataUnsafe?.user?.language_code &&
    translations[window.Telegram.WebApp.initDataUnsafe.user.language_code]) {
  lang = window.Telegram.WebApp.initDataUnsafe.user.language_code;
} else if (navigator.language && translations[navigator.language.slice(0,2)]) {
  lang = navigator.language.slice(0,2);
}

/* ===========================
   DOM references
   =========================== */
const tg = window.Telegram?.WebApp || null;
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
const textInput = document.getElementById('text-input');
const generateBtn = document.getElementById('generate-btn');
const qrcodeContainer = document.getElementById('qrcode-container');
const qrcodeDiv = document.getElementById('qrcode');
const downloadBtn = document.getElementById('download-btn');
const statsDiv = document.getElementById('stats');
const startScanBtn = document.getElementById('start-scan-btn');
const uploadScanBtn = document.getElementById('upload-scan-btn');
const stopScanBtn = document.getElementById('stop-scan-btn');
const cameraSwitchBtn = document.getElementById('camera-switch-btn');
const scannerContainer = document.getElementById('scanner-container');
const scannerStatus = document.getElementById('scanner-status');
const statusText = document.getElementById('status-text');
const scanResultContainer = document.getElementById('scan-result-container');
const scanResultText = document.getElementById('scan-result-text');
const copyResultBtn = document.getElementById('copy-result-btn');
const useResultBtn = document.getElementById('use-result-btn');
const scanAgainBtn = document.getElementById('scan-again-btn');
const qrInputFile = document.getElementById('qr-input-file');
const scanResultTitle = document.getElementById('scan-result-title');

/* ===========================
   UI text initialization
   =========================== */
document.querySelector('h3').textContent = 'üîí QR Generator & Scanner';
document.querySelector('.description').textContent = translations[lang].placeholder;
textInput.placeholder = translations[lang].placeholder;
generateBtn.textContent = translations[lang].generate;
downloadBtn.textContent = translations[lang].download;
startScanBtn.textContent = translations[lang].scanCamera || translations[lang].scanCamera;
uploadScanBtn.textContent = translations[lang].scanFile;
copyResultBtn.textContent = translations[lang].copy;
useResultBtn.textContent = translations[lang].useResult;
scanAgainBtn.textContent = translations[lang].scanAgain;
stopScanBtn.textContent = translations[lang].stopScan;
scanResultTitle.textContent = translations[lang].scannedResult;
tabs[0].textContent = lang === 'ru' ? '‚úèÔ∏è –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä' : '‚úèÔ∏è Generator';
tabs[1].textContent = lang === 'ru' ? 'üì∑ –°–∫–∞–Ω–µ—Ä' : 'üì∑ Scanner';

/* ===========================
   Helpers: notifications, safe MainButton
   =========================== */
function showNotification(message) {
  if (tg?.showAlert) {
    try { tg.showAlert(message); } catch(e){ console.warn(e); }
    return;
  }
  const el = document.createElement('div');
  el.className = 'web-notification';
  el.textContent = message;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 3000);
}

/* safe MainButton setter */
function setMainButton({text='', onClick=null, show=false, enable=false}) {
  if (!tg?.MainButton) return;
  try {
    // Clear previous listeners safely if API supports it
    if (typeof tg.MainButton.offClick === 'function') {
      // best-effort remove both candidate handlers (some SDKs require exact function ref)
      try { tg.MainButton.offClick(onClick); } catch(e) {}
    }
  } catch(e) { /* ignore */ }

  try {
    tg.MainButton.setText(text || '');
    if (onClick && typeof tg.MainButton.onClick === 'function') tg.MainButton.onClick(onClick);
    if (show) tg.MainButton.show(); else tg.MainButton.hide();
    if (enable) tg.MainButton.enable(); else tg.MainButton.disable();
  } catch(e) {
    console.warn('MainButton error', e);
  }
}

/* ===========================
   QR generation
   =========================== */
let currentCanvas = null;

function generateQRCode(text) {
  qrcodeDiv.innerHTML = '';
  currentCanvas = document.createElement('canvas');
  qrcodeDiv.appendChild(currentCanvas);
  try {
    new QRious({
      element: currentCanvas,
      value: text,
      size: 256,
      level: 'H',
      background: '#ffffff',
      foreground: '#000000',
      padding: 10
    });
    qrcodeContainer.style.display = 'flex';
    const charCount = text.length;
    const isUrl = /^https?:\/\//i.test(text);
    statsDiv.textContent = `${charCount} ${translations[lang].chars} ${isUrl ? translations[lang].url : translations[lang].text}`;
    if (tg?.HapticFeedback) try{ tg.HapticFeedback.notificationOccurred('success'); }catch(e){}
    setTimeout(()=>qrcodeContainer.scrollIntoView({behavior:'smooth',block:'center'}),120);
  } catch(err) {
    console.error(err);
    showNotification(`${translations[lang].errorGen}: ${err.message || err}`);
    if (tg?.HapticFeedback) try{ tg.HapticFeedback.notificationOccurred('error'); }catch(e){}
  }
}

function triggerGenerateQR() {
  const text = textInput.value.trim();
  if (!text) { showNotification(translations[lang].errorEmpty); return; }
  if (text.length > 2953) { showNotification(translations[lang].errorTooLong); return; }
  generateQRCode(text);
  if (tg) try { textInput.blur(); } catch(e){}
}

/* Save / share */
function fallbackDownload(blob, fileName) {
  try {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = fileName;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
    showNotification(translations[lang].saved);
  } catch(e) { console.error(e); showNotification(translations[lang].saveFailed); }
}

downloadBtn.addEventListener('click', async () => {
  if (!currentCanvas) return;
  currentCanvas.toBlob(async (blob) => {
    const timestamp = new Date().toISOString().slice(0,10);
    const fileName = `qrcode_${timestamp}.png`;
    const file = new File([blob], fileName, {type:'image/png'});
    // try Web Share
    try {
      if (navigator.share && navigator.canShare && navigator.canShare({files:[file]})) {
        await navigator.share({files:[file], title:'QR Code', text:textInput.value.trim().substring(0,100)});
        return;
      }
    } catch(e){ console.warn('Share failed', e); }
    // fallback
    fallbackDownload(blob, fileName);
  }, 'image/png');
});

/* keyboard submit for web */
generateBtn.addEventListener('click', triggerGenerateQR);
textInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); triggerGenerateQR(); }
});

/* ===========================
   Scanner logic
   =========================== */
let html5QrCode = null;
let currentFacingMode = 'environment';
let isScanning = false;

function createSmartButton(text, onClick) {
  const btn = document.createElement('button');
  btn.id = 'smart-action-btn';
  btn.className = 'btn btn-primary';
  btn.textContent = text;
  btn.style.marginBottom = '10px';
  btn.onclick = onClick;
  return btn;
}

function onScanSuccess(decodedText) {
  stopScanning().catch(()=>{});
  scanResultText.textContent = decodedText;
  scanResultContainer.style.display = 'block';

  // smart actions
  const old = document.getElementById('smart-action-btn'); if (old) old.remove();
  let smartBtn = null;
  if (/^https?:\/\//i.test(decodedText)) {
    smartBtn = createSmartButton('üåê ' + translations[lang].openLink, () => {
      if (tg?.openLink) try{ tg.openLink(decodedText); return; }catch(e){}
      window.open(decodedText, '_blank');
    });
  } else if (/^tel:/i.test(decodedText) || /^\+?\d/.test(decodedText) ) {
    const tel = decodedText.startsWith('tel:') ? decodedText : `tel:${decodedText}`;
    smartBtn = createSmartButton('üìû ' + translations[lang].call, () => { window.location.href = tel; });
  } else if (/^mailto:/i.test(decodedText)) {
    smartBtn = createSmartButton('‚úâÔ∏è ' + translations[lang].email, () => { window.location.href = decodedText; });
  }
  if (smartBtn) useResultBtn.parentNode.prepend(smartBtn);

  if (tg?.HapticFeedback) try{ tg.HapticFeedback.notificationOccurred('success'); }catch(e){}
  setTimeout(()=>scanResultContainer.scrollIntoView({behavior:'smooth'}),120);
}

async function startScanning() {
  try {
    scannerContainer.style.display = 'block';
    scannerStatus.style.display = 'block';
    statusText.textContent = translations[lang].scanningStatus;
    stopScanBtn.style.display = 'block';
    startScanBtn.style.display = 'none';
    uploadScanBtn.style.display = 'none';
    scanResultContainer.style.display = 'none';

    html5QrCode = new Html5Qrcode('qr-reader');
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    const constraints = { facingMode: currentFacingMode };
    await html5QrCode.start(constraints, config, onScanSuccess, (err) => {
      // optional per-frame callback
    });
    isScanning = true;

    // update MainButton in telegram
    if (tg?.MainButton) {
      setMainButton({ text: translations[lang].stopScan, onClick: stopScanning, show:true, enable:true });
    }
    if (tg?.HapticFeedback) try{ tg.HapticFeedback.impactOccurred('medium'); }catch(e){}
  } catch (error) {
    let msg = translations[lang].errorGen;
    if (error?.name === 'NotAllowedError') msg = translations[lang].cameraDenied;
    else if (error?.name === 'NotFoundError') msg = translations[lang].cameraNotFound;
    console.warn(error);
    showNotification(msg);
    resetScannerUI();
  }
}

async function stopScanning() {
  try {
    if (html5QrCode && isScanning) {
      await html5QrCode.stop();
      html5QrCode.clear();
    }
  } catch(e){}
  isScanning = false;
  resetScannerUI();
  if (tg?.MainButton) setMainButton({ show:false });
}

function resetScannerUI() {
  scannerContainer.style.display = 'none';
  scannerStatus.style.display = 'none';
  stopScanBtn.style.display = 'none';
  startScanBtn.style.display = 'block';
  uploadScanBtn.style.display = 'block';
}

async function switchCamera() {
  currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
  if (isScanning) {
    await stopScanning();
    await startScanning();
  }
  if (tg?.HapticFeedback) try{ tg.HapticFeedback.impactOccurred('light'); }catch(e){}
}

async function scanFromFile(file) {
  try {
    scannerStatus.style.display = 'block';
    statusText.textContent = translations[lang].analysis;
    const reader = new Html5Qrcode('qr-reader');
    const result = await reader.scanFile(file, true);
    onScanSuccess(result);
  } catch(e) {
    console.warn(e);
    showNotification(translations[lang].notFound);
    scannerStatus.style.display = 'none';
  }
}

/* scanner event handlers */
startScanBtn.addEventListener('click', startScanning);
stopScanBtn.addEventListener('click', () => { stopScanning().catch(()=>{}); });
cameraSwitchBtn?.addEventListener('click', switchCamera);
uploadScanBtn?.addEventListener('click', () => qrInputFile.click());
qrInputFile.addEventListener('change', (e) => { const f = e.target.files?.[0]; if (f) scanFromFile(f); qrInputFile.value = ''; });

copyResultBtn.addEventListener('click', () => {
  const text = scanResultText.textContent;
  if (!text) return;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(()=> showNotification(translations[lang].copied)).catch(()=>showNotification('Copy failed'));
  } else {
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); ta.remove(); showNotification(translations[lang].copied);
  }
});

useResultBtn.addEventListener('click', () => {
  const text = scanResultText.textContent || '';
  // switch to generator and populate
  tabs[0].click();
  textInput.value = text;
  triggerGenerateQR();
});

scanAgainBtn.addEventListener('click', () => {
  scanResultContainer.style.display = 'none';
  startScanning();
});

/* ===========================
   Tabs management
   =========================== */
tabs.forEach(tab => tab.addEventListener('click', function() {
  const tabName = this.dataset.tab;
  tabs.forEach(t => t.classList.remove('active'));
  tabContents.forEach(c => c.classList.remove('active'));
  this.classList.add('active');
  document.getElementById(tabName).classList.add('active');

  // update Telegram MainButton behavior based on tab and state
  if (tg?.MainButton) {
    // detach previous handlers by setting a fresh configuration (best-effort)
    try { setMainButton({ show:false }); } catch(e){}

    if (tabName === 'generator') {
      setMainButton({ text: translations[lang].generate, onClick: triggerGenerateQR, show:true, enable: textInput.value.trim().length>0 });
    } else if (tabName === 'scanner') {
      if (isScanning) {
        setMainButton({ text: translations[lang].stopScan, onClick: stopScanning, show:true, enable:true });
      } else {
        setMainButton({ show:false });
      }
    }
  }

  // if switching to generator while scanning - stop camera
  if (tabName === 'generator' && isScanning) stopScanning();
}));

/* enable/disable MainButton on input */
textInput.addEventListener('input', () => {
  if (tg?.MainButton) {
    const has = textInput.value.trim().length > 0;
    try { if (has) tg.MainButton.enable(); else tg.MainButton.disable(); } catch(e){}
  }
});

/* ===========================
   Telegram init & binding
   =========================== */
if (tg) {
  try { tg.ready(); } catch(e){}
  try { tg.expand(); } catch(e){}
  try { if (tg.setHeaderColor) tg.setHeaderColor('bg_color'); } catch(e){}

  // Ensure initial MainButton is bound immediately (fix for original bug)
  // Do this after triggerGenerateQR is defined above
  try {
    if (tg.MainButton) {
      // default: generator action visible if generator tab active
      const isGenActive = document.querySelector('.tab[data-tab="generator"]').classList.contains('active');
      if (isGenActive) {
        setMainButton({ text: translations[lang].generate, onClick: triggerGenerateQR, show:true, enable: textInput.value.trim().length>0 });
      } else {
        setMainButton({ show:false });
      }
    }
  } catch(e) { console.warn('MainButton init failed', e); }
}

/* fallback: when not in Telegram, ensure generator button is visible & works */
if (!tg) {
  generateBtn.style.display = 'block';
  downloadBtn.style.display = 'block';
}

/* cleanup on unload */
window.addEventListener('beforeunload', () => { if (isScanning) try{ html5QrCode?.stop(); }catch(e){} });
</script>
</body>
</html>
