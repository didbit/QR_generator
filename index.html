<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Generator & Scanner</title>
    
    <!-- Telegram Web App API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- QRious Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"
            integrity="sha512-pUhApVQtLbnpLtJn6DuzDD5o2xtmLJnJ7oBoMsBnzOkVkpqofGLGPaBJ6ayD2zQe3lCgCibhJBi4cj5wAxwVKA=="
            crossorigin="anonymous"></script>
    <!-- html5-qrcode Ð´Ð»Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h3 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .description {
            text-align: center;
            margin: 0 10px 20px;
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            line-height: 1.4;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--tg-theme-secondary-bg-color, #f4f4f4);
            padding: 5px;
            border-radius: 12px;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        .tab.active {
            background: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            background-color: var(--tg-theme-secondary-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
        }
        textarea:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #007aff);
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, #007aff);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .btn-secondary {
            background-color: var(--tg-theme-secondary-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #000000);
        }
        .btn-danger {
            background-color: #ff3b30;
            color: #ffffff;
        }
        .btn:active {
            opacity: 0.7;
        }

        #qrcode-container {
            margin-top: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
        }
        #qrcode {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #qrcode canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
        .stats {
            margin-top: 15px;
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
            text-align: center;
        }

        #qr-reader__dashboard_section_swaplink {
            display: none !important;
        }
        #qr-reader {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        .scanner-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        @media (max-width: 480px) {
            .scanner-controls {
                flex-direction: column;
            }
        }
        .camera-switch {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--tg-theme-button-color, #007aff);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .scan-result {
            background: var(--tg-theme-secondary-bg-color, #f4f4f4);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        .scan-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .scan-result-text {
            word-break: break-all;
            white-space: pre-wrap;
        }

        .web-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h3></h3>
        <p class="description"></p>
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="generator"></div>
            <div class="tab" data-tab="scanner"></div>
        </div>
        <!-- Generator -->
        <div class="tab-content active" id="generator">
            <textarea id="text-input" autocomplete="off" spellcheck="false"></textarea>
            <button class="btn btn-primary" id="generate-btn" style="margin-top:15px;"></button>
            <div id="qrcode-container">
                <div id="qrcode"></div>
                <button class="btn btn-primary" id="download-btn" style="margin-top:15px;"></button>
                <div class="stats" id="stats"></div>
            </div>
        </div>
        <!-- Scanner -->
        <div class="tab-content" id="scanner">
            <div id="scanner-view">
                <div class="scanner-controls">
                    <button class="btn btn-primary" id="start-scan-btn"></button>
                    <button class="btn btn-secondary" id="upload-scan-btn"></button>
                </div>
                <input type="file" id="qr-input-file" accept="image/*" style="display:none;">
                <div id="scanner-container" style="display:none; margin-top:20px; position:relative;">
                    <button class="camera-switch" id="camera-switch-btn" aria-label="Switch camera" title="Switch camera">ðŸ”„</button>
                    <div id="qr-reader"></div>
                </div>
                <div class="scanner-status" id="scanner-status" style="display:none; text-align:center; margin-top:20px;">
                    <div class="spinner"></div>
                    <div id="status-text"></div>
                </div>
                <div id="scan-result-container" style="display:none;">
                    <div class="scan-result">
                        <div class="scan-result-header">
                            <strong id="scan-result-title"></strong>
                            <button class="btn btn-secondary" id="copy-result-btn" style="padding:6px 12px; font-size:14px;"></button>
                        </div>
                        <div class="scan-result-text" id="scan-result-text"></div>
                    </div>
                    <div class="scanner-controls" style="margin-top:15px;">
                        <button class="btn btn-primary" id="use-result-btn"></button>
                        <button class="btn btn-secondary" id="scan-again-btn"></button>
                    </div>
                </div>
                <button class="btn btn-danger" id="stop-scan-btn" style="display:none;margin-top:15px;"></button>
            </div>
        </div>
    </div>

<script>
    // ===== ÐœÑƒÐ»ÑŒÑ‚Ð¸ÑÐ·Ñ‹Ñ‡Ð½Ð¾ÑÑ‚ÑŒ =====
    const translations = {
      ru: {
        generate: 'Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ QR-ÐºÐ¾Ð´',
        placeholder: 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚, ÑÑÑ‹Ð»ÐºÑƒ Ð¸Ð»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ QR-ÐºÐ¾Ð´Ð°...',
        download: 'ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ QR-ÐºÐ¾Ð´',
        saved: 'QR-ÐºÐ¾Ð´ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½',
        errorEmpty: 'ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð»Ð¸ ÑÑÑ‹Ð»ÐºÑƒ!',
        errorTooLong: 'Ð¢ÐµÐºÑÑ‚ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ð¹. ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ 2953 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°.',
        scanningStatus: 'ÐŸÐ¾Ð¸ÑÐº QR-ÐºÐ¾Ð´Ð°...',
        scanCamera: 'ðŸ“· Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ',
        scanFile: 'ðŸ–¼ï¸ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾',
        copy: 'ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ',
        useResult: 'âœï¸ Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ QR',
        scanAgain: 'ðŸ”„ Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÑ‰Ñ‘',
        stopScan: 'â›” ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ',
        scannedResult: 'âœ… Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:',
        chars: 'ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² â€¢',
        url: 'URL',
        text: 'Ð¢ÐµÐºÑÑ‚',
        analysis: 'ÐÐ½Ð°Ð»Ð¸Ð· Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ...',
        notFound: 'QR-ÐºÐ¾Ð´ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð½Ð° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¸',
        copied: 'Ð¢ÐµÐºÑÑ‚ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½',
        errorGen: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ QR-ÐºÐ¾Ð´Ð°',
        cameraDenied: 'Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ Ð·Ð°Ð¿Ñ€ÐµÑ‰Ñ‘Ð½. Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð°.',
        cameraNotFound: 'ÐšÐ°Ð¼ÐµÑ€Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð½Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ.',
        saveFailed: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸',
        openLink: 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ',
        call: 'ÐŸÐ¾Ð·Ð²Ð¾Ð½Ð¸Ñ‚ÑŒ',
        email: 'ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ E-mail'
      },
      en: {
        generate: 'Generate QR code',
        placeholder: 'Enter text, URL or data for QR code...',
        download: 'ðŸ’¾ Save QR code',
        saved: 'QR code saved',
        errorEmpty: 'Please enter text or URL!',
        errorTooLong: 'Text too long. Maximum 2953 characters.',
        scanningStatus: 'Scanning for QR code...',
        scanCamera: 'ðŸ“· Start camera',
        scanFile: 'ðŸ–¼ï¸ Upload photo',
        copy: 'ðŸ“‹ Copy',
        useResult: 'âœï¸ Generate QR',
        scanAgain: 'ðŸ”„ Scan again',
        stopScan: 'â›” Stop scanning',
        scannedResult: 'âœ… Scan result:',
        chars: 'characters â€¢',
        url: 'URL',
        text: 'Text',
        analysis: 'Analysing image...',
        notFound: 'QR code not found on image',
        copied: 'Text copied',
        errorGen: 'QR code generation error',
        cameraDenied: 'Camera access denied. Allow in browser settings.',
        cameraNotFound: 'Camera not found on device.',
        saveFailed: 'Save failed',
        openLink: 'Open Link',
        call: 'Call',
        email: 'Send E-mail'
      }
    };

    let lang = 'en';
    if (window.Telegram?.WebApp?.initDataUnsafe?.user?.language_code && translations[window.Telegram.WebApp.initDataUnsafe.user.language_code]) {
      lang = window.Telegram.WebApp.initDataUnsafe.user.language_code;
    } else if (navigator.language && translations[navigator.language.slice(0,2)]) {
      lang = navigator.language.slice(0,2);
    }

    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Telegram WebApp
    const tg = window.Telegram?.WebApp || null;
    if (tg) {
        tg.ready(); // â† Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ€Ð°Ð·Ñƒ!
        tg.expand();
        tg.setHeaderColor('bg_color');
    }

    // DOM
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const textInput = document.getElementById('text-input');
    const generateBtn = document.getElementById('generate-btn');
    const qrcodeContainer = document.getElementById('qrcode-container');
    const qrcodeDiv = document.getElementById('qrcode');
    const downloadBtn = document.getElementById('download-btn');
    const statsDiv = document.getElementById('stats');
    const startScanBtn = document.getElementById('start-scan-btn');
    const uploadScanBtn = document.getElementById('upload-scan-btn');
    const stopScanBtn = document.getElementById('stop-scan-btn');
    const cameraSwitchBtn = document.getElementById('camera-switch-btn');
    const scannerContainer = document.getElementById('scanner-container');
    const scannerStatus = document.getElementById('scanner-status');
    const statusText = document.getElementById('status-text');
    const scanResultContainer = document.getElementById('scan-result-container');
    const scanResultText = document.getElementById('scan-result-text');
    const copyResultBtn = document.getElementById('copy-result-btn');
    const useResultBtn = document.getElementById('use-result-btn');
    const scanAgainBtn = document.getElementById('scan-again-btn');
    const qrInputFile = document.getElementById('qr-input-file');
    const scanResultTitle = document.getElementById('scan-result-title');

    // Ð¢ÐµÐºÑÑ‚Ñ‹
    document.querySelector('h3').textContent = 'ðŸ”’ QR Generator & Scanner';
    document.querySelector('.description').textContent = translations[lang].placeholder;
    textInput.placeholder = translations[lang].placeholder;
    generateBtn.textContent = translations[lang].generate;
    downloadBtn.textContent = translations[lang].download;
    startScanBtn.textContent = translations[lang].scanCamera;
    uploadScanBtn.textContent = translations[lang].scanFile;
    copyResultBtn.textContent = translations[lang].copy;
    useResultBtn.textContent = translations[lang].useResult;
    scanAgainBtn.textContent = translations[lang].scanAgain;
    stopScanBtn.textContent = translations[lang].stopScan;
    scanResultTitle.textContent = translations[lang].scannedResult;
    tabs[0].textContent = lang === 'ru' ? 'âœï¸ Ð“ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€' : 'âœï¸ Generator';
    tabs[1].textContent = lang === 'ru' ? 'ðŸ“· Ð¡ÐºÐ°Ð½ÐµÑ€' : 'ðŸ“· Scanner';

    // Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
    function showNotification(message) {
      if (tg?.showAlert) {
        tg.showAlert(message);
      } else {
        const notification = document.createElement('div');
        notification.className = 'web-notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
          if (notification.parentNode) notification.parentNode.removeChild(notification);
        }, 3000);
      }
    }

    function createSmartButton(text, onClick) {
        const btn = document.createElement('button');
        btn.id = 'smart-action-btn';
        btn.className = 'btn btn-primary';
        btn.textContent = text;
        btn.style.marginBottom = '10px';
        btn.onclick = onClick;
        return btn;
    }

    // ===== Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ =====
    let currentCanvas = null;

    function triggerGenerateQR() {
      const text = textInput.value.trim();
      if (!text) {
        showNotification(translations[lang].errorEmpty);
        return;
      }
      if (text.length > 2953) {
        showNotification(translations[lang].errorTooLong);
        return;
      }
      generateQRCode(text);
      if (tg) textInput.blur();
    }

    function generateQRCode(text) {
      qrcodeDiv.innerHTML = '';
      currentCanvas = document.createElement('canvas');
      qrcodeDiv.appendChild(currentCanvas);
      try {
        new QRious({
          element: currentCanvas,
          value: text,
          size: 256,
          level: 'H',
          background: '#ffffff',
          foreground: '#000000',
          padding: 10
        });
        qrcodeContainer.style.display = 'flex';
        const charCount = text.length;
        const isUrl = /^https?:\/\//i.test(text);
        statsDiv.textContent = `${charCount} ${translations[lang].chars} ${isUrl ? translations[lang].url : translations[lang].text}`;
        if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        setTimeout(() => {
          qrcodeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      } catch (error) {
        showNotification(`${translations[lang].errorGen}: ${error.message}`);
        if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
      }
    }

    // ===== Shared Save (Web Share API + fallback) =====
    downloadBtn.addEventListener('click', async () => {
        if (!currentCanvas) return;

        currentCanvas.toBlob(async (blob) => {
            const timestamp = new Date().toISOString().slice(0, 10);
            const fileName = `qrcode_${timestamp}.png`;
            const file = new File([blob], fileName, { type: 'image/png' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'QR Code',
                        text: textInput.value.trim().substring(0, 100)
                    });
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.warn('Share failed, falling back to download', error);
                        fallbackDownload(blob, fileName);
                    }
                }
            } else {
                fallbackDownload(blob, fileName);
            }
        }, 'image/png');
    });

    function fallbackDownload(blob, fileName) {
        try {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = fileName;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification(translations[lang].saved);
        } catch (error) {
            console.error('Download fallback failed:', error);
            showNotification(translations[lang].saveFailed);
        }
    }

    // ===== Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ =====
    let html5QrCode = null;
    let currentFacingMode = 'environment';
    let isScanning = false;

    function onScanSuccess(decodedText) {
        stopScanning();
        scanResultText.textContent = decodedText;
        scanResultContainer.style.display = 'block';
        
        // --- Ð£Ð¼Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· ---
        const oldSmartBtn = document.getElementById('smart-action-btn');
        if (oldSmartBtn) oldSmartBtn.remove();

        let smartBtn = null;
        if (/^https?:\/\//i.test(decodedText)) {
            smartBtn = createSmartButton('ðŸŒ ' + translations[lang].openLink, () => {
                if (tg) tg.openLink(decodedText);
                else window.open(decodedText, '_blank');
            });
        } else if (decodedText.startsWith('tel:')) {
            smartBtn = createSmartButton('ðŸ“ž ' + translations[lang].call, () => {
                if (tg) tg.openTelegramLink(decodedText);
                else window.location.href = decodedText;
            });
        } else if (decodedText.startsWith('mailto:')) {
            smartBtn = createSmartButton('âœ‰ï¸ ' + translations[lang].email, () => {
                window.location.href = decodedText;
            });
        }
        if (smartBtn) {
            useResultBtn.parentNode.prepend(smartBtn);
        }
        // --- ÐšÐ¾Ð½ÐµÑ† Ð°Ð½Ð°Ð»Ð¸Ð·Ð° ---

        if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        setTimeout(() => {
            scanResultContainer.scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }

    async function startScanning() {
        try {
            scannerContainer.style.display = 'block';
            scannerStatus.style.display = 'block';
            statusText.textContent = translations[lang].scanningStatus;
            stopScanBtn.style.display = 'block';
            startScanBtn.style.display = 'none';
            uploadScanBtn.style.display = 'none';
            scanResultContainer.style.display = 'none';

            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const constraints = { facingMode: currentFacingMode };
            await html5QrCode.start(constraints, config, onScanSuccess, () => {});
            isScanning = true;

            // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ MainButton
            if (tg?.MainButton) {
                tg.MainButton.setText(translations[lang].stopScan);
                tg.MainButton.onClick(stopScanning);
                tg.MainButton.show();
            }

            if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        } catch (error) {
            let errorMsg = translations[lang].errorGen;
            if (error.name === 'NotAllowedError') errorMsg = translations[lang].cameraDenied;
            else if (error.name === 'NotFoundError') errorMsg = translations[lang].cameraNotFound;
            showNotification(errorMsg);
            resetScannerUI();
        }
    }

    async function stopScanning() {
        if (html5QrCode && isScanning) {
            try {
                await html5QrCode.stop();
                html5QrCode.clear();
            } catch (e) {}
        }
        isScanning = false;
        resetScannerUI();

        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ MainButton
        if (tg?.MainButton && document.querySelector('#scanner').classList.contains('active')) {
            tg.MainButton.hide();
        }
    }

    function resetScannerUI() {
        scannerContainer.style.display = 'none';
        scannerStatus.style.display = 'none';
        stopScanBtn.style.display = 'none';
        startScanBtn.style.display = 'block';
        uploadScanBtn.style.display = 'block';
    }

    async function switchCamera() {
        currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
        if (isScanning) {
            await stopScanning();
            await startScanning();
        }
        if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    async function scanFromFile(file) {
        try {
            scannerStatus.style.display = 'block';
            statusText.textContent = translations[lang].analysis;
            html5QrCode = new Html5Qrcode("qr-reader");
            const result = await html5QrCode.scanFile(file, true);
            onScanSuccess(result);
        } catch (error) {
            showNotification(translations[lang].notFound);
            scannerStatus.style.display = 'none';
        }
    }

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐºÐ°Ð½ÐµÑ€Ð°
    startScanBtn.addEventListener('click', startScanning);
    stopScanBtn.addEventListener('click', stopScanning);
    cameraSwitchBtn.addEventListener('click', switchCamera);
    uploadScanBtn.addEventListener('click', () => { qrInputFile.click(); });
    qrInputFile.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (file) scanFromFile(file);
        qrInputFile.value = '';
    });

    copyResultBtn.addEventListener('click', () => {
        const text = scanResultText.textContent;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification(translations[lang].copied);
            });
        } else {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification(translations[lang].copied);
        }
    });

    useResultBtn.addEventListener('click', () => {
        const text = scanResultText.textContent;
        tabs[0].click();
        textInput.value = text;
        triggerGenerateQR();
    });

    scanAgainBtn.addEventListener('click', () => {
        scanResultContainer.style.display = 'none';
        startScanning();
    });

    // ===== Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²ÐºÐ»Ð°Ð´ÐºÐ°Ð¼Ð¸ Ð¸ MainButton =====
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tg?.MainButton) {
                tg.MainButton.offClick(triggerGenerateQR);
                tg.MainButton.offClick(stopScanning);

                if (tabName === 'generator') {
                    tg.MainButton.setText(translations[lang].generate);
                    tg.MainButton.onClick(triggerGenerateQR);
                    tg.MainButton.show();
                    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸
                    const hasText = textInput.value.trim().length > 0;
                    if (hasText) tg.MainButton.enable();
                    else tg.MainButton.disable();
                } else if (tabName === 'scanner') {
                    if (isScanning) {
                        tg.MainButton.setText(translations[lang].stopScan);
                        tg.MainButton.onClick(stopScanning);
                        tg.MainButton.show();
                    } else {
                        tg.MainButton.hide();
                    }
                }
            }

            if (tabName === 'generator' && isScanning) stopScanning();
            // Ð£Ð±Ñ€Ð°Ð»Ð¸ haptic Ð½Ð° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð²ÐºÐ»Ð°Ð´Ð¾Ðº
        });
    });

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ MainButton Ð¿Ñ€Ð¸ Ð²Ð²Ð¾Ð´Ðµ
    if (tg?.MainButton) {
        textInput.addEventListener('input', () => {
            const text = textInput.value.trim();
            if (text.length > 0) {
                tg.MainButton.enable();
            } else {
                tg.MainButton.disable();
            }
        });
    }

    // Ð”Ð»Ñ Ð²ÐµÐ±-Ð²ÐµÑ€ÑÐ¸Ð¸
    if (!tg) {
        generateBtn.style.display = 'block';
        generateBtn.addEventListener('click', triggerGenerateQR);
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                triggerGenerateQR();
            }
        });
    }

    window.addEventListener('beforeunload', () => {
        if (isScanning) stopScanning();
    });
</script>
</body>
</html>
